# Описание воркфлоу n8n: Qr Test.json

## Общее описание
Воркфлоу "Qr Test" предназначен для автоматического размещения QR-кодов на изображениях с использованием искусственного интеллекта. Это Telegram-бот, который получает фотографии от пользователей, анализирует их с помощью LLM-моделей (Claude от Anthropic), определяет оптимальное место для размещения QR-кода, накладывает QR-код через внешний API и отправляет результат обратно в чат. Воркфлоу интегрирует Telegram API, AI-анализ изображений и HTTP-запросы к локальному серверу для обработки изображений.

## Структура воркфлоу

### Основные компоненты
- **Триггер:** Telegram Trigger - срабатывает на новые сообщения с фотографиями
- **Обработка входных данных:** Извлечение и подготовка изображений
- **AI-анализ:** Анализ изображений с помощью LLM для выбора позиции QR-кода
- **Наложение QR-кода:** HTTP-запрос к внешнему API для генерации и наложения QR
- **Отправка результата:** Возврат обработанного изображения в Telegram

### Поток обработки

1. **New message trigger** - Получает новое сообщение из Telegram с фото
2. **Split List** - Извлекает массив фотографий из сообщения
3. **Get last item** - Берет последнее фото (самое качественное)
4. **Get qr size (optional)** - Вычисляет размер QR-кода как 20% от меньшей стороны изображения
5. **Set fields** - Устанавливает базовые поля (размеры изображения, URL ngrok, размер QR)
6. **Get a file** - Скачивает изображение из Telegram
7. **AI-анализ изображений:**
   - **AI Agent** - Агент с инструментом Think для анализа свободных областей
   - **OpenRouter Chat Model1** - Модель Gemini для первичного анализа
   - **HTTP Request1** - Альтернативный запрос к OpenRouter
   - **Anthropic Chat Model1** - Claude с Extended Thinking для детального анализа
   - **Basic LLM Chain** - Финальный анализ с промптом для определения координат
   - **Structured Output Parser** - Парсинг JSON-ответа от LLM
   - **Code in JavaScript1/2** - Обработка и очистка ответов
8. **Combine fields** - Собирает все необходимые данные (координаты, размеры, chat_id)
9. **HTTP Request** - Отправляет изображение и параметры на локальный сервер (через ngrok) для наложения QR-кода
10. **Get a file1** - Скачивает обработанное изображение с результатом
11. **Send a photo message** - Отправляет финальное изображение обратно в Telegram чат

### Дополнительные элементы
- **Sticky Notes:** Подробные комментарии и описания каждого этапа обработки
- **Edit Fields2** - Опциональная установка фиксированных координат для тестирования
- **Think** - Инструмент для анализа изображений и выбора безопасных зон

## Цель воркфлоу
Воркфлоу предназначен для демонстрации интеграции AI в процесс обработки изображений:
- **Автоматическое размещение QR-кодов:** AI анализирует изображение и выбирает оптимальное место, избегая важных объектов
- **Безопасное позиционирование:** QR-код не перекрывает лица, текст, логотипы или ключевые элементы
- **Интеграция с Telegram:** Полная автоматизация от получения фото до отправки результата
- **Тестирование AI-моделей:** Сравнение разных LLM (Claude, Gemini) для задач компьютерного зрения

Воркфлоу демонстрирует практическое применение AI для решения реальных задач по обработке изображений и интеграции с мессенджерами.